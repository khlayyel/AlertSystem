@{
    ViewData["Title"] = "Dashboard";
    var role = (string?)ViewBag.Role ?? "";
    var departments = ViewBag.Departments as List<AlertSystem.Models.Entities.Department>;
}
<div class="container py-3">
  <div class="mb-3">
    <h3 class="mb-1">Tableau de bord</h3>
    <div class="text-muted">Bienvenue</div>
  </div>

  <!-- Pending Alerts Section -->
  <div class="row mb-3" id="pendingAlertsSection" style="display: none;">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">‚è≥ Alertes en cours d'envoi</h5>
        </div>
        <div class="card-body" id="pendingAlertsList">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3" id="kpiRow">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-sm kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="kpi-label">Alertes du jour</div>
              <div class="kpi-value" id="kpiToday">‚Äî</div>
            </div>
            <span class="kpi-dot bg-primary"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-sm kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="kpi-label">Obligatoires en attente</div>
              <div class="kpi-value" id="kpiPending">‚Äî</div>
            </div>
            <span class="kpi-dot bg-warning"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-sm kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="kpi-label">Obligatoires confirm√©es</div>
              <div class="kpi-value" id="kpiConfirmedMandatory">‚Äî</div>
            </div>
            <span class="kpi-dot bg-success"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gmail-style Tabs -->
  <ul class="nav nav-tabs gmail-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#inbox" type="button">
        <i class="bi bi-inbox me-2"></i>Bo√Æte de r√©ception
        <span id="unreadCount" class="badge bg-danger ms-2" style="display:none;">0</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sent" type="button">
        <i class="bi bi-send me-2"></i>Bo√Æte d'envoi
      </button>
    </li>
  </ul>

  <!-- Gmail-style Content -->
  <div class="tab-content gmail-content">
    <!-- Inbox Tab -->
    <div class="tab-pane fade show active" id="inbox">
      <div class="gmail-container">
        <!-- Empty State -->
        <div id="inboxEmpty" class="gmail-empty-state" style="display:none;">
          <div class="empty-icon">
            <i class="bi bi-envelope-open" style="font-size: 4rem; color: #9aa0a6;"></i>
          </div>
          <h3 class="empty-title">Votre bo√Æte de r√©ception est vide</h3>
          <p class="empty-subtitle">Aucune alerte re√ßue pour le moment</p>
        </div>

        <!-- Alert List -->
        <div id="inboxList" class="gmail-list">
          <div class="gmail-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <span class="ms-2">Chargement des alertes...</span>
          </div>
        </div>

        <!-- Pagination -->
        <div id="inboxPagination" class="gmail-pagination" style="display:none;">
          <div class="d-flex justify-content-between align-items-center">
            <span class="gmail-pagination-info">
              <span id="inboxRangeStart">1</span>-<span id="inboxRangeEnd">50</span> sur <span id="inboxTotal">0</span>
            </span>
            <div class="gmail-pagination-controls">
              <button id="inboxPrevBtn" class="btn btn-sm btn-outline-secondary me-2" disabled>
                <i class="bi bi-chevron-left"></i>
              </button>
              <button id="inboxNextBtn" class="btn btn-sm btn-outline-secondary" disabled>
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sent Tab -->
    <div class="tab-pane fade" id="sent">
      <div class="gmail-container">
        <!-- Empty State -->
        <div id="sentEmpty" class="gmail-empty-state" style="display:none;">
          <div class="empty-icon">
            <i class="bi bi-envelope-check" style="font-size: 4rem; color: #9aa0a6;"></i>
          </div>
          <h3 class="empty-title">Votre bo√Æte d'envoi est vide</h3>
          <p class="empty-subtitle">Aucune alerte envoy√©e pour le moment</p>
        </div>

        <!-- Alert List -->
        <div id="sentList" class="gmail-list">
          <div class="gmail-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <span class="ms-2">Chargement des alertes...</span>
          </div>
        </div>

        <!-- Pagination -->
        <div id="sentPagination" class="gmail-pagination" style="display:none;">
          <div class="d-flex justify-content-between align-items-center">
            <span class="gmail-pagination-info">
              <span id="sentRangeStart">1</span>-<span id="sentRangeEnd">50</span> sur <span id="sentTotal">0</span>
            </span>
            <div class="gmail-pagination-controls">
              <button id="sentPrevBtn" class="btn btn-sm btn-outline-secondary me-2" disabled>
                <i class="bi bi-chevron-left"></i>
              </button>
              <button id="sentNextBtn" class="btn btn-sm btn-outline-secondary" disabled>
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Compose Button (Gmail-style) -->
  <div class="gmail-compose-fab" id="composeFab">
    <button type="button" class="btn btn-primary btn-lg rounded-pill shadow-lg" data-bs-toggle="modal" data-bs-target="#newAlertModal">
      <i class="bi bi-plus-lg me-2"></i>Composer
    </button>
  </div>

  <!-- Alert Cancellation Toast (Gmail-style) -->
  <div id="alertCancellationToast" class="gmail-toast" style="display:none;">
    <div class="toast-content">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm text-light me-3" role="status">
          <span class="visually-hidden">Envoi en cours...</span>
        </div>
        <span class="toast-message">Envoi en cours...</span>
      </div>
      <button type="button" class="btn btn-sm btn-outline-light ms-3" id="cancelSendBtn">
        Annuler
      </button>
    </div>
  </div>
</div>

<!-- Modal Nouvelle Alerte -->
<div class="modal fade" id="newAlertModal" tabindex="-1" aria-labelledby="newAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="newAlertModalLabel">
          <i class="bi bi-bell me-2"></i>Nouvelle alerte
        </h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Section Alertes rapides -->
        <div class="card mb-4">
          <div class="card-header bg-primary">
            <h6 class="mb-0"><i class="bi bi-lightning me-1"></i>Alertes rapides</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <select id="modalQuickSelect" class="form-select">
                  <option value="">-- S√©lectionner une alerte rapide --</option>
                </select>
              </div>
              <div class="col-md-4 text-end">
                <small class="text-muted">S√©lectionnez pour remplir automatiquement</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulaire principal -->
        <form id="newAlertForm">
          <div class="row g-3">
            <!-- Titre -->
            <div class="col-12">
              <label class="form-label fw-bold">
                <i class="bi bi-pencil me-1"></i>Titre de l'alerte *
              </label>
              <input id="modalTitle" class="form-control" required placeholder="Entrez le titre de l'alerte..." />
            </div>
            
            <!-- Message -->
            <div class="col-12">
              <label class="form-label fw-bold">
                <i class="bi bi-chat-text me-1"></i>Message
              </label>
              <textarea id="modalMessage" class="form-control" rows="4" placeholder="Entrez le message de l'alerte..."></textarea>
            </div>
            
            <!-- Type -->
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="bi bi-tag me-1"></i>Type d'alerte
              </label>
              <select id="modalAlertType" class="form-select">
                <option value="Information">üìÑ Information</option>
                <option value="Obligatoire">‚ö†Ô∏è Obligatoire</option>
              </select>
            </div>
          </div>
          
          <!-- Plateformes d'envoi (en haut) -->
          <div class="card mt-4 order-0">
            <div class="card-header bg-success">
              <h6 class="mb-0"><i class="bi bi-send me-1"></i>Plateformes d'envoi</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12">
                  <label class="form-label fw-bold">S√©lectionnez les moyens d'envoi :</label>
                  <div class="mt-2">
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" id="platformEmail" value="email">
                      <label class="form-check-label" for="platformEmail">
                        <i class="bi bi-envelope me-1 text-primary"></i>Email
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" id="platformWhatsApp" value="whatsapp">
                      <label class="form-check-label" for="platformWhatsApp">
                        <i class="bi bi-whatsapp me-1 text-success"></i>WhatsApp
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" id="platformDesktop" value="desktop">
                      <label class="form-check-label" for="platformDesktop">
                        <i class="bi bi-bell me-1 text-warning"></i>Notification Desktop
                      </label>
                    </div>
                  </div>
                  <div class="form-text mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    S√©lectionnez une ou plusieurs plateformes.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Coordonn√©es des destinataires (saisie libre) -->
          <div class="card mt-4 order-1">
            <div class="card-header bg-info">
              <h6 class="mb-0"><i class="bi bi-people me-1"></i>Coordonn√©es des destinataires</h6>
            </div>
            <div class="card-body">
              <div id="emailBlock" class="mb-3" style="display:none;">
                <label class="form-label fw-bold"><i class="bi bi-envelope me-1"></i>Emails</label>
                <div id="emailsTags" class="form-control d-flex flex-wrap gap-1" style="min-height:2.6rem; padding-top:.375rem; padding-bottom:.375rem;"></div>
                <small class="text-muted">Saisissez un email puis Entr√©e, virgule ou point-virgule.</small>
                <input type="hidden" id="emailsInput" />
              </div>
              <div id="whatsBlock" class="mb-3" style="display:none;">
                <label class="form-label fw-bold"><i class="bi bi-whatsapp me-1"></i>Num√©ros WhatsApp</label>
                <div id="whatsTags" class="form-control d-flex flex-wrap gap-1" style="min-height:2.6rem; padding-top:.375rem; padding-bottom:.375rem;"></div>
                <small class="text-muted">Saisissez un num√©ro (ex: +21650123456) puis Entr√©e, virgule ou point-virgule.</small>
                <input type="hidden" id="whatsInput" />
              </div>
              <div id="desktopBlock" class="mb-2" style="display:none;">
                <label class="form-label fw-bold"><i class="bi bi-bell me-1"></i>Device IDs (optionnel, s√©par√©s par virgule)</label>
                <input id="deviceIdsInput" class="form-control" placeholder="ex: device-abc, device-xyz" />
              </div>
              <div class="form-text">Ces champs apparaissent selon les plateformes s√©lectionn√©es.</div>
            </div>
          </div>

          <!-- API Key Management -->
          <div class="card mt-4">
            <div class="card-header bg-warning">
              <h6 class="mb-0"><i class="bi bi-key me-1"></i>Configuration API</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label fw-bold">Cl√© API</label>
                  <div class="input-group">
                    <input type="password" id="apiKeyInput" class="form-control" placeholder="Entrez votre cl√© API..." />
                    <button type="button" id="toggleApiKeyBtn" class="btn btn-outline-secondary">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  <small class="text-muted">La cl√© API est n√©cessaire pour envoyer des alertes via l'API</small>
                </div>
                <div class="col-md-4">
                  <label class="form-label">&nbsp;</label>
                  <div class="d-grid gap-2">
                    <button type="button" id="saveApiKeyBtn" class="btn btn-outline-primary btn-sm">
                      <i class="bi bi-save me-1"></i>Sauvegarder
                    </button>
                    <button type="button" id="testApiKeyBtn" class="btn btn-outline-success btn-sm">
                      <i class="bi bi-check-circle me-1"></i>Tester
                    </button>
                  </div>
                </div>
              </div>
              <div id="apiKeyStatus" class="mt-2"></div>
            </div>
          </div>
          
          <!-- Section Plateformes d'envoi (ancienne) supprim√©e car d√©plac√©e au-dessus -->
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Annuler
        </button>
        <button type="button" id="modalSaveBtn" class="btn btn-outline-primary">
          <i class="bi bi-lightning me-1"></i>Enregistrer comme alerte rapide
        </button>
        <button type="button" id="modalSendBtn" class="btn btn-success btn-lg">
          <i class="bi bi-send me-1"></i>Envoyer l'alerte
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Alert Detail Modal (Gmail-style) -->
<div class="modal fade gmail-alert-detail" id="alertDetailModal" tabindex="-1" aria-labelledby="alertDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertDetailModalLabel">D√©tails de l'alerte</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="alert-header">
          <div class="alert-title" id="detailTitle">Titre de l'alerte</div>
          <div class="alert-meta">
            <span id="detailSender"><i class="bi bi-person me-1"></i>Exp√©diteur</span>
            <span id="detailDate"><i class="bi bi-calendar me-1"></i>Date</span>
            <span id="detailType"><i class="bi bi-tag me-1"></i>Type</span>
            <span id="detailStatus"><i class="bi bi-check-circle me-1"></i>Statut</span>
          </div>
        </div>
        <div class="alert-content" id="detailContent">
          Contenu de l'alerte...
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" id="markAsReadBtn" style="display:none;">
          <i class="bi bi-check me-1"></i>Marquer comme lu
        </button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script src="~/gmail-dashboard.js"></script>
<script>
// Additional modal functionality for existing features
async function loadModalQuickAlerts() {
  try {
    const res = await fetch('/AlertsCrud/QuickList');
    const items = await res.json();
    const sel = document.getElementById('modalQuickSelect');
    if (sel) {
      sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
      items.forEach(x => {
        const o = document.createElement('option');
        o.value = x.alertId;
        o.textContent = x.title;
        sel.appendChild(o);
      });
    }
  } catch (error) {
    console.error('Error loading quick alerts:', error);
  }
}

async function loadModalRecipients() {
  try {
    const res = await fetch('/AlertsCrud/Recipients');
    const items = await res.json();
    console.debug('[Recipients] loaded:', Array.isArray(items)? items.length : items);
    if (Array.isArray(items)) {
      const ids = items.map(x=>x.userId);
      console.debug('[Recipients] ids sample:', ids.slice(0,20));
    }
    const container = document.getElementById('modalRecipients');
    if (container) {
      container.innerHTML = '';
      
      if (items.length === 0) {
        container.innerHTML = '<div class="text-muted text-center p-3">Aucun destinataire disponible</div>';
        return;
      }
      
      items.forEach(x => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'form-check mb-2 p-2 border-bottom';
        checkboxDiv.dataset.department = x.departmentId || '';
        checkboxDiv.dataset.role = x.role || '';
        
        const checkbox = document.createElement('input');
        checkbox.className = 'form-check-input';
        checkbox.type = 'checkbox';
        checkbox.id = `recipient_${x.userId}`;
        checkbox.value = x.userId;
        checkbox.name = 'recipients';
        
        const label = document.createElement('label');
        label.className = 'form-check-label w-100';
        label.htmlFor = `recipient_${x.userId}`;
        label.style.cursor = 'pointer';
        
        const roleIcon = x.role === 'Admin' ? 'üëë' : x.role === 'SuperUser' ? '‚≠ê' : 'üë§';
        const deptBadge = x.departmentName ? `<span class="badge bg-secondary ms-2">${x.departmentName}</span>` : '';
        
        label.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${roleIcon} ${x.username}</strong>
              <div class="text-muted small">${x.email || 'Pas d\'email'}</div>
            </div>
            ${deptBadge}
          </div>
        `;
        
        checkbox.addEventListener('change', updateRecipientCount);
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        container.appendChild(checkboxDiv);
      });
      
      const searchInput = document.getElementById('modalRecipientsSearch');
      if (searchInput) {
        searchInput.removeEventListener('input', filterCheckboxes);
        searchInput.addEventListener('input', filterCheckboxes);
      }
    }
  } catch (error) {
    console.error('Error loading recipients:', error);
    const container = document.getElementById('modalRecipients');
    if (container) {
      container.innerHTML = '<div class="text-danger text-center p-3">Erreur lors du chargement des destinataires</div>';
    }
  }
}

function filterCheckboxes(event) {
  const searchTerm = event.target.value.toLowerCase();
  const container = document.getElementById('modalRecipients');
  if (container) {
    const checkboxDivs = container.querySelectorAll('.form-check');
    checkboxDivs.forEach(div => {
      const text = div.textContent.toLowerCase();
      div.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  }
}

function updateRecipientCount() {
  const container = document.getElementById('modalRecipients');
  const countBadge = document.getElementById('recipientCount');
  if (container && countBadge) {
    const checkedCount = container.querySelectorAll('input[type="checkbox"]:checked').length;
    countBadge.textContent = `${checkedCount} s√©lectionn√©(s)`;
    countBadge.className = checkedCount > 0 ? 'badge bg-success' : 'badge bg-primary';
  }
}

// Initialize modal data when shown
document.getElementById('newAlertModal')?.addEventListener('shown.bs.modal', function() {
  loadModalQuickAlerts();
  loadModalRecipients();
});
</script>
}
