@{
    ViewData["Title"] = "Test Historique Alerte";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Test Historique Alerte - Nouvelle Structure
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">Structure HistoriqueAlerte</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>DestinataireId:</strong> Clé primaire</li>
                                        <li><strong>AlerteId:</strong> Référence vers Alerte</li>
                                        <li><strong>DestinataireUserId:</strong> Référence vers Users</li>
                                        <li><strong>EtatAlerte:</strong> Lu / Non Lu</li>
                                        <li><strong>DateLecture:</strong> Quand lu</li>
                                        <li><strong>RappelSuivant:</strong> Prochain rappel</li>
                                        <li><strong>DestinataireEmail:</strong> Email du destinataire</li>
                                        <li><strong>DestinatairePhoneNumber:</strong> Téléphone/WhatsApp</li>
                                        <li><strong>DestinataireDesktop:</strong> Token Web Push</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">Actions de Test</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-primary btn-sm mb-2 w-100" onclick="chargerHistorique()">
                                        <i class="bi bi-list-ul me-1"></i>Charger Historique
                                    </button>
                                    <button class="btn btn-info btn-sm mb-2 w-100" onclick="chargerStatistiques()">
                                        <i class="bi bi-bar-chart me-1"></i>Charger Statistiques
                                    </button>
                                    <button class="btn btn-warning btn-sm mb-2 w-100" onclick="chargerRappels()">
                                        <i class="bi bi-alarm me-1"></i>Rappels en Attente
                                    </button>
                                    <button class="btn btn-success btn-sm w-100" onclick="testerMarquerLu()">
                                        <i class="bi bi-check-circle me-1"></i>Test Marquer Lu
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Onglets pour les résultats -->
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="historique-tab" data-bs-toggle="tab" data-bs-target="#historique" type="button" role="tab">
                                <i class="bi bi-list-ul me-1"></i>Historique
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                                <i class="bi bi-bar-chart me-1"></i>Statistiques
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rappels-tab" data-bs-toggle="tab" data-bs-target="#rappels" type="button" role="tab">
                                <i class="bi bi-alarm me-1"></i>Rappels
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="resultTabsContent">
                        <!-- Onglet Historique -->
                        <div class="tab-pane fade show active" id="historique" role="tabpanel">
                            <div id="historique-loading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement de l'historique...</p>
                            </div>
                            <div id="historique-content">
                                <p class="text-muted">Cliquez sur "Charger Historique" pour voir les données.</p>
                            </div>
                        </div>

                        <!-- Onglet Statistiques -->
                        <div class="tab-pane fade" id="stats" role="tabpanel">
                            <div id="stats-loading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement des statistiques...</p>
                            </div>
                            <div id="stats-content">
                                <p class="text-muted">Cliquez sur "Charger Statistiques" pour voir les données.</p>
                            </div>
                        </div>

                        <!-- Onglet Rappels -->
                        <div class="tab-pane fade" id="rappels" role="tabpanel">
                            <div id="rappels-loading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement des rappels...</p>
                            </div>
                            <div id="rappels-content">
                                <p class="text-muted">Cliquez sur "Rappels en Attente" pour voir les données.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast pour les notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body">
            <!-- Message dynamique -->
        </div>
    </div>
</div>

<script>
// Fonctions pour tester la nouvelle API HistoriqueAlerte
async function chargerHistorique() {
    const loading = document.getElementById('historique-loading');
    const content = document.getElementById('historique-content');
    
    loading.style.display = 'block';
    content.innerHTML = '';
    
    try {
        const response = await fetch('/api/v1/HistoriqueAlerte?page=1&size=20');
        const data = await response.json();
        
        if (response.ok) {
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>Historique des Alertes (${data.total} total)</h6>
                    <span class="badge bg-primary">${data.items.length} affichés</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Alerte</th>
                                <th>Destinataire</th>
                                <th>Contact</th>
                                <th>État</th>
                                <th>Date Lecture</th>
                                <th>Rappel</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.items.forEach(item => {
                const etatBadge = item.statut.etatAlerte === 'Lu' ? 
                    '<span class="badge bg-success">Lu</span>' : 
                    '<span class="badge bg-warning">Non Lu</span>';
                
                const dateLecture = item.statut.dateLecture ? 
                    new Date(item.statut.dateLecture).toLocaleString('fr-FR') : 
                    '-';
                
                const rappel = item.statut.rappelSuivant ? 
                    new Date(item.statut.rappelSuivant).toLocaleString('fr-FR') : 
                    '-';
                
                html += `
                    <tr>
                        <td>${item.destinataireId}</td>
                        <td>
                            <strong>${item.titreAlerte}</strong><br>
                            <small class="text-muted">${item.descriptionAlerte?.substring(0, 50)}...</small>
                        </td>
                        <td>
                            <strong>${item.destinataire.fullName}</strong><br>
                            <small class="text-muted">${item.destinataire.email}</small>
                        </td>
                        <td>
                            <small>
                                📧 ${item.contact.email}<br>
                                📱 ${item.contact.phoneNumber}<br>
                                🖥️ ${item.contact.desktop?.substring(0, 20)}...
                            </small>
                        </td>
                        <td>${etatBadge}</td>
                        <td><small>${dateLecture}</small></td>
                        <td><small>${rappel}</small></td>
                        <td>
                            ${item.statut.etatAlerte === 'Non Lu' ? 
                                `<button class="btn btn-sm btn-success" onclick="marquerLu(${item.destinataireId})">
                                    <i class="bi bi-check"></i>
                                </button>` : 
                                '<span class="text-muted">-</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            content.innerHTML = html;
            
            // Activer l'onglet historique
            document.getElementById('historique-tab').click();
        } else {
            content.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
        }
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Erreur de connexion: ${error.message}</div>`;
    } finally {
        loading.style.display = 'none';
    }
}

async function chargerStatistiques() {
    const loading = document.getElementById('stats-loading');
    const content = document.getElementById('stats-content');
    
    loading.style.display = 'block';
    content.innerHTML = '';
    
    try {
        const response = await fetch('/api/v1/HistoriqueAlerte/stats');
        const data = await response.json();
        
        if (response.ok) {
            let html = `
                <h6>Statistiques par Destinataire</h6>
                <div class="row">
            `;
            
            data.forEach(stat => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">${stat.destinataire.fullName}</h6>
                                <small class="text-muted">${stat.destinataire.email}</small>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="text-primary">
                                            <strong>${stat.statistiques.totalAlertes}</strong>
                                            <br><small>Total</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-success">
                                            <strong>${stat.statistiques.alertesLues}</strong>
                                            <br><small>Lues</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row text-center mt-2">
                                    <div class="col-6">
                                        <div class="text-warning">
                                            <strong>${stat.statistiques.alertesNonLues}</strong>
                                            <br><small>Non Lues</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-info">
                                            <strong>${stat.statistiques.rappelsEnAttente}</strong>
                                            <br><small>Rappels</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: ${stat.statistiques.tauxLecture}%">
                                            ${Math.round(stat.statistiques.tauxLecture)}%
                                        </div>
                                    </div>
                                    <small class="text-muted">Taux de lecture</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            
            // Activer l'onglet stats
            document.getElementById('stats-tab').click();
        } else {
            content.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
        }
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Erreur de connexion: ${error.message}</div>`;
    } finally {
        loading.style.display = 'none';
    }
}

async function chargerRappels() {
    const loading = document.getElementById('rappels-loading');
    const content = document.getElementById('rappels-content');
    
    loading.style.display = 'block';
    content.innerHTML = '';
    
    try {
        const response = await fetch('/api/v1/HistoriqueAlerte/rappels');
        const data = await response.json();
        
        if (response.ok) {
            if (data.length === 0) {
                content.innerHTML = '<div class="alert alert-info">Aucun rappel en attente.</div>';
            } else {
                let html = `
                    <h6>Rappels en Attente (${data.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-warning">
                                <tr>
                                    <th>Alerte</th>
                                    <th>Destinataire</th>
                                    <th>Rappel Prévu</th>
                                    <th>Minutes Restantes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(rappel => {
                    const minutesClass = rappel.minutesRestantes <= 30 ? 'text-danger' : 
                                       rappel.minutesRestantes <= 60 ? 'text-warning' : 'text-success';
                    
                    html += `
                        <tr>
                            <td><strong>${rappel.titreAlerte}</strong></td>
                            <td>
                                <strong>${rappel.destinataire.fullName}</strong><br>
                                <small class="text-muted">${rappel.destinataire.email}</small>
                            </td>
                            <td>${new Date(rappel.rappelSuivant).toLocaleString('fr-FR')}</td>
                            <td class="${minutesClass}">
                                <strong>${rappel.minutesRestantes} min</strong>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                content.innerHTML = html;
            }
            
            // Activer l'onglet rappels
            document.getElementById('rappels-tab').click();
        } else {
            content.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
        }
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Erreur de connexion: ${error.message}</div>`;
    } finally {
        loading.style.display = 'none';
    }
}

async function marquerLu(destinataireId) {
    try {
        const response = await fetch(`/api/v1/HistoriqueAlerte/${destinataireId}/marquer-lu`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            showToast('Succès', `Alerte marquée comme lue pour le destinataire ${destinataireId}`, 'success');
            // Recharger l'historique pour voir les changements
            chargerHistorique();
        } else {
            showToast('Erreur', data.error, 'danger');
        }
    } catch (error) {
        showToast('Erreur', `Erreur de connexion: ${error.message}`, 'danger');
    }
}

async function testerMarquerLu() {
    // Marquer le premier destinataire non lu comme lu
    try {
        const response = await fetch('/api/v1/HistoriqueAlerte?page=1&size=1');
        const data = await response.json();
        
        if (response.ok && data.items.length > 0) {
            const premier = data.items.find(item => item.statut.etatAlerte === 'Non Lu');
            if (premier) {
                await marquerLu(premier.destinataireId);
            } else {
                showToast('Info', 'Aucune alerte non lue trouvée', 'info');
            }
        }
    } catch (error) {
        showToast('Erreur', `Erreur: ${error.message}`, 'danger');
    }
}

function showToast(title, message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastBody = document.getElementById('toast-body');
    
    // Définir la couleur selon le type
    const colors = {
        success: 'text-bg-success',
        danger: 'text-bg-danger',
        warning: 'text-bg-warning',
        info: 'text-bg-info'
    };
    
    toast.className = `toast ${colors[type] || colors.info}`;
    toastBody.textContent = message;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Charger automatiquement l'historique au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    chargerHistorique();
});
</script>
